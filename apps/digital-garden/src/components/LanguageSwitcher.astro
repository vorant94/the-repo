---
import { getCollection } from "astro:content";
import { isLanguage, type Language, languages } from "../globals/i18n.ts";
import { createFilterPostsByLang } from "../lib/content.ts";
import ButtonLink from "./ui/ButtonLink.astro";
import Icon from "./ui/Icon.astro";

const currentLang = Astro.currentLocale;
if (!currentLang) {
  throw new Error("Current language is missing");
}
if (!isLanguage(currentLang)) {
  throw new Error(
    `Current language ${currentLang} isn't supported by LanguageSwitcher`,
  );
}

const langToSwitchTo = languages.filter((lang) => lang !== currentLang).at(0);
if (!langToSwitchTo) {
  throw new Error("Language to switch to is missing");
}

const [enPostIds, ruPostIds] = await Promise.all(
  languages.map(async (lang) => {
    const posts = await getCollection("posts", createFilterPostsByLang(lang));
    return posts.map(({ id }) => id.split("/").at(1)).filter(Boolean);
  }),
);

const langToPostIds = {
  en: enPostIds ?? [],
  ru: ruPostIds ?? [],
} satisfies Record<Language, Array<string>>;

const pathnameSplits = Astro.url.pathname.split("/");
const postIdPathnameIndex = 3;
const postId = pathnameSplits.at(postIdPathnameIndex);

let switchToUrl = "";
if (postId && !langToPostIds[langToSwitchTo].includes(postId)) {
  switchToUrl = new URL(`${langToSwitchTo}`, Astro.url.origin).toString();
} else {
  const langPathnameIndex = 1;
  const newPathname = pathnameSplits
    .map((part, index) => (index === langPathnameIndex ? langToSwitchTo : part))
    .join("/");

  switchToUrl = new URL(newPathname, Astro.url.origin).toString();
}
---

<ButtonLink href={switchToUrl} aria-label={`switch to ${langToSwitchTo}`}>
  <Icon glyph={langToSwitchTo}/>
</ButtonLink>
