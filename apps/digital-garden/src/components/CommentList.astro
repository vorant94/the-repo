---
interface Props {
  postSlug: string;
}

const { postSlug } = Astro.props;
---

<va-comment-list data-postslug={postSlug}>
  <div class="mt-8 space-y-4">
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">
      Comments
    </h3>

    <div id="comment-list-outlet" class="space-y-3"></div>
  </div>

  <template id="comment-list-item-template">
    <div class="rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 p-4 shadow-sm">
      <div class="flex items-center justify-between mb-2">
        <span id="comment-author-outlet" class="font-semibold text-gray-900 dark:text-gray-100"></span>
        <time id="comment-date-outlet" class="text-xs text-gray-500 dark:text-gray-400"></time>
      </div>
      <p id="comment-text-outlet" class="text-sm text-gray-700 dark:text-gray-300 leading-relaxed"></p>
    </div>
  </template>
</va-comment-list>


<script>
import { actions } from "astro:actions";
import type { CommentWithAuthor } from '../lib/comments';
import { customEvents } from '../globals/custom-events';
import { formatDistanceToNow } from 'date-fns';

customElements.define('va-comment-list', class extends HTMLElement {
  #commentListOutletEl!: HTMLElement;
  #commentListItemTemplateEl!: HTMLTemplateElement;

  get postSlug() {
    const value = this.dataset.postslug;
    if(!value) {
      throw new Error('postslug is missing')
    }

    return value;
  }

  connectedCallback() {
    this.#queryElements();

    void this.#fetchAndRenderComments();

    document.addEventListener(customEvents.commentAdded, this.#renderNewlyAddedComment);
  }

  disconnectedCallback() {
    document.removeEventListener(customEvents.commentAdded, this.#renderNewlyAddedComment);
  }

  #queryElements() {
    const commentListOutletEl = this.querySelector<HTMLElement>("#comment-list-outlet");
    if (!commentListOutletEl) {
      throw new Error("Can't find comment list outlet");
    }
    this.#commentListOutletEl = commentListOutletEl;

    const commentListItemTemplateEl = this.querySelector<HTMLTemplateElement>("#comment-list-item-template");
    if (!commentListItemTemplateEl) {
      throw new Error("Can't find comment list item template");
    }
    this.#commentListItemTemplateEl = commentListItemTemplateEl;
  }

  #fetchAndRenderComments = async (): Promise<void> => {
    const result = await actions.fetchComments({postSlug: this.postSlug});
    if(result.error) {
      return;
    }

    this.#commentListOutletEl.textContent = '';

    for (const comment of result.data) {
      this.#commentListOutletEl.appendChild(this.#renderComment(comment))
    }
  }

  #renderNewlyAddedComment = ({detail}: CustomEvent<CommentWithAuthor>): void => {
    this.#commentListOutletEl.appendChild(this.#renderComment(detail));
  }

  #renderComment(comment: CommentWithAuthor): DocumentFragment {
    const clone = document.importNode(this.#commentListItemTemplateEl.content, true);

    const textEl = clone.getElementById('comment-text-outlet');
    if(!textEl) {
      throw new Error("Can't find comment text outlet")
    }
    textEl.removeAttribute('id')
    textEl.textContent = comment.text;

    const authorEl = clone.getElementById('comment-author-outlet');
    if(!authorEl) {
      throw new Error("Can't find comment author outlet")
    }
    authorEl.removeAttribute('id')
    authorEl.textContent = comment.author?.username ?? 'Anonymous';

    const dateEl = clone.getElementById('comment-date-outlet');
    if(!dateEl) {
      throw new Error("Can't find comment date outlet")
    }
    dateEl.removeAttribute('id')
    const date = new Date(comment.createdAt);
    dateEl.setAttribute('datetime', comment.createdAt);
    dateEl.textContent = formatDistanceToNow(date, { addSuffix: true });

    return clone;
  }
})
</script>
