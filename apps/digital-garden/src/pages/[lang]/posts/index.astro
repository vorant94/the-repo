---
import { getCollection } from "astro:content";
import { format } from "date-fns";
import PostList from "../../../components/PostList.astro";
import PostListItem from "../../../components/PostListItem.astro";
import { languages } from "../../../globals/i18n";
import { publishedAtFormat } from "../../../globals/published-at-format";
import DefaultLayout from "../../../layouts/DefaultLayout.astro";
import {
  createFilterPostsByLang,
  sortPostsByPublishedAt,
} from "../../../utils/content.helpers";
import { createTranslate } from "../../../utils/i18n.helpers";

export function getStaticPaths() {
  return languages.map((lang) => ({
    params: { lang },
  }));
}
const filteredPosts = await getCollection(
  "posts",
  createFilterPostsByLang(Astro.currentLocale),
);
const sortedPosts = sortPostsByPublishedAt(filteredPosts);

const groupedPosts = Object.groupBy(sortedPosts, (post) =>
  format(post.data.publishedAt, publishedAtFormat.year),
);

const sortedPostYears = Object.keys(groupedPosts).reverse();

const t = createTranslate(Astro.currentLocale);
---

<DefaultLayout title={t("posts.title")}>
	{sortedPostYears.map((year) => (
		<PostList>
			<Fragment slot="title">
				{year}
			</Fragment>

			{groupedPosts[year]!.map((post) => (
				<PostListItem post={post} />
			))}
		</PostList>
	))}
</DefaultLayout>
